{"version":3,"sources":["stomp_client.js"],"names":[],"mappings":"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","file":"protocols/stomp_client.js","sourcesContent":["/**\n * A module that exports an StompClient client\n * which inherits from the SpaceBunny base client\n * @module StompClient\n */\n\n// Import some helpers modules\nimport merge from 'merge';\nimport Promise from 'bluebird';\n\n// Import stomp library\nimport Stomp from 'stompjs';\n\n// Import SpaceBunny main module from which StompClient inherits\nimport SpaceBunny from '../spacebunny';\n\n/**\n * @constructor\n * @param {Object} opts - constructor options may contain api-key or connection options\n */\nclass StompClient extends SpaceBunny {\n  constructor(opts) {\n    super(opts);\n    this._client = undefined;\n    this._connectionHeaders = {\n      'max_hbrlck_fails': 10,\n      'accept-version': '1.0,1.1,1.2',\n      'heart-beat': '10000,10000'\n    };\n    this._existingQueuePrefix = 'amq/queue';\n    this.connection();\n  }\n\n  /**\n   * Subscribe to input channel\n   *\n   * @param {function} callback - function called every time a message is receviced\n   * passing the current message as argument\n   * @param {Object} options - subscription options\n   * @return promise containing the result of the subscription\n   */\n  onReceive(callback, opts) {\n    opts = merge({}, opts);\n    // subscribe for input messages\n    return new Promise((resolve, reject) => {\n      this._connect().then((client) => {\n        // amq/queue is the form for existing queues\n        client.subscribe(this._subcriptionFor(this._existingQueuePrefix, this._inputTopic), function(message) {\n          callback(message);\n        }, function(reason) {\n          reject(reason);\n        });\n        resolve(true);\n      }).catch(function(reason) {\n        reject(reason);\n      });\n    });\n  }\n\n  /**\n   * Publish a message on a specific channel\n   *\n   * @param {String} channel - channel name on which you want to publish a message\n   * @param {Object} message - the message payload\n   * @param {Object} message - the message payload\n   * @return promise containing true if the\n   */\n  publish(channel, message, opts) {\n    opts = merge({}, opts);\n    // Publish message\n    return new Promise((resolve, reject) => {\n      this._connect().then((client) => {\n        client.send(this._destinationFor('exchange', channel), this._connectionHeaders, this._encapsulateContent(message));\n        resolve(true);\n      }).catch(function(reason) {\n        reject(reason);\n      });\n    });\n  }\n\n  /**\n   * Destroy the connection between the stomp client and broker\n   *\n   * @return a promise containing the result of the operation\n   */\n  disconnect() {\n    return new Promise((resolve, reject) => {\n      if (this._client === undefined) {\n        reject('Invalid connection');\n      } else {\n        this._client.disconnect().then(function() {\n          resolve(true);\n        }).catch(function(reason) {\n          reject(reason);\n        });\n      }\n    });\n  }\n\n  // ------------ PRIVATE METHODS -------------------\n\n  /**\n   * @private\n   * Establish an stomp connection with the broker\n   * using configurations retrieved from the endpoint\n   *\n   * @param {Object} opts - connection options\n   * @return a promise containing current connection\n   */\n  _connect(opts) {\n    opts = merge({}, opts);\n    const connectionParams = this._connectionParams;\n\n    return new Promise((resolve, reject) => {\n      if (this._client !== undefined) {\n        resolve(this._client);\n      } else {\n        try {\n          let client = undefined;\n          if (typeof process === 'object' && process + '' === '[object process]') {\n            // code is runnning in nodejs: STOMP uses TCP sockets\n            client = Stomp.overTCP(connectionParams.host, connectionParams.protocols.stomp.port);\n          } else {\n            const SockJS = require('sockjs-client');\n            // code is runnning in a browser: web STOMP uses Web sockets\n            const connectionString = `http://${connectionParams.host}:${connectionParams.protocols.web_stomp.port}/stomp`;\n            const ws = new SockJS(connectionString);\n            client = Stomp.over(ws);\n            // SockJS does not support heart-beat: disable heart-beats\n            client.heartbeat.outgoing = 0;\n            client.heartbeat.incoming = 0;\n          }\n          const headers = merge(this._connectionHeaders, {\n            login: connectionParams.device_id,\n            passcode: connectionParams.secret,\n            host: connectionParams.vhost\n          });\n          client.connect(headers, () => {\n            this._client = client;\n            resolve(this._client);\n          }, function(err) {\n            reject(err);\n          });\n        } catch (reason) {\n          reject(reason);\n        }\n      }\n    });\n  }\n\n  /**\n   * @private\n   * Generate the subscription string for a specific channel\n   *\n   * @param {String} type - resource type on which subscribe or publish [exchange/queue]\n   * @param {String} channel - channel name on which you want to publish a message\n   * @return a string that represents the topic name for that channel\n   */\n  _subcriptionFor(type, channel) {\n    return `/${type}/${this.deviceId()}.${channel}`;\n  }\n\n  /**\n   * @private\n   * Generate the destination string for a specific channel\n   *\n   * @param {String} type - resource type on which subscribe or publish [exchange/queue]\n   * @param {String} channel - channel name on which you want to publish a message\n   * @return a string that represents the topic name for that channel\n   */\n  _destinationFor(type, channel) {\n    return `/${type}/${this.deviceId()}/${this.deviceId()}.${channel}`;\n  }\n\n}\n\nexport default StompClient;\n"],"sourceRoot":"/Users/gfoiani/Dev/work/JS/spacebunny-node/src"}